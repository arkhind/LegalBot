# Руководство по работе с чеками ЮKassa

## 📋 Обзор

Система автоматически создает и отправляет чеки пользователям при создании платежа через ЮKassa. Чек создается автоматически при создании платежа с указанным email.

## 🔧 Настройка

### Требования
- Настроенный аккаунт ЮKassa
- `YOOKASSA_SHOP_ID` и `YOOKASSA_SECRET_KEY` в `.env`
- Включенная функция чеков в личном кабинете ЮKassa

### Переменные окружения
```env
YOOKASSA_SHOP_ID=your_shop_id
YOOKASSA_SECRET_KEY=your_secret_key
```

## 📧 Процесс работы с чеками

### 1. Запрос email
При выборе консультации пользователю предлагается:
- 📧 Ввести email для получения чека
- 🚫 Отказаться от чека

### 2. Валидация email
- Проверяется корректность формата email
- При ошибке предлагается повторить ввод

### 3. Создание платежа
- Платеж создается с сохранением email
- Email сохраняется в базе данных

### 4. Создание чека
При создании платежа:
- Автоматически создается чек через ЮKassa API
- Чек отправляется на указанный email
- После оплаты пользователь получает уведомление о чеке

## 🗄️ Структура базы данных

### Таблица consultations
```sql
ALTER TABLE consultations ADD COLUMN email VARCHAR(255);
```

### Поля чека
- `payment_id` - ID платежа
- `email` - Email пользователя
- `consultation_type` - Тип консультации
- `amount` - Сумма оплаты

## 🔍 Отладка

### Проверка настроек
```bash
python test_receipt.py
```

### Логи
- Создание чека: `logger.info("Чек создан для платежа {payment_id}")`
- Ошибки: `logger.error("Ошибка создания чека: {error}")`

### Возможные ошибки
1. **ЮKassa не настроена** - проверьте переменные окружения
2. **Платеж не найден** - проверьте корректность payment_id
3. **Неверный email** - проверьте формат email
4. **Ошибка API** - проверьте настройки в личном кабинете ЮKassa

## 📝 Пример чека

```
🧾 ЧЕК ОБ ОПЛАТЕ

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📅 Дата: 20.08.2025 19:30
🆔 Номер чека: 12345678-1234-1234-1234-123456789012
👤 Покупатель: Иван Иванов
🆔 Telegram ID: 123456789
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 Услуга: Устная консультация
💰 Сумма: 10₽
💳 Способ оплаты: ЮKassa
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ Статус: Оплачено
🔐 Кодовое слово: ЮРИСТ2024
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📞 Поддержка: @narhipovd
🌐 Сайт: https://xn--d1achcyjfchw0b0fya.net/
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 🚀 Тестирование

### Запуск теста
```bash
python test_receipt.py
```

### Проверка в боте
1. Выберите консультацию
2. Введите корректный email
3. Оплатите консультацию
4. Проверьте получение чека на email

## 📞 Поддержка

При проблемах с чеками:
- Проверьте логи бота
- Убедитесь в корректности настроек ЮKassa
- Обратитесь в поддержку: @narhipovd
